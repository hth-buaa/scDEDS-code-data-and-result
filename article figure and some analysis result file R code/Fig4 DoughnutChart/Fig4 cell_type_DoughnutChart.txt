library(ggplot2)
library(dplyr)
library(colorspace)
library(ggnewscale)


##### 1 Reading Data #####
setwd("D:/pbmc-equation/")
Basic_Info <- readRDS("./pr50 newest for paper/1.3 Data Preprocessing - Get Expression And Activity Matrix/Basic_Info.rds")

table(Basic_Info[["scRNAseq_for_GRN"]]@meta.data$seurat_annotations)
cell_labels = names(table(Basic_Info[["scRNAseq_for_GRN"]]@meta.data$seurat_annotations))
cell_labels_num = table(Basic_Info[["scRNAseq_for_GRN"]]@meta.data$seurat_annotations)


##### 2 Data Extraction #####
T_cell_labels = c("CD4 Naive", "CD4 TCM", "CD4 TEM", "CD8 Naive", "CD8 TEM_1", "CD8 TEM_2", "Treg", "gdT","MAIT")
B_cell_labels = c("Naive B", "Intermediate B", "Memory B", "Plasma")
NK_cell_labels = "NK"
Myeloid_labels = c("CD14 Mono", "CD16 Mono", "cDC")
Rare_cell_labels = c("HSPC", "pDC")
Unclassified_labels = "filtered"

T_cell_labels_num = sum(cell_labels_num[T_cell_labels])
B_cell_labels_num = sum(cell_labels_num[B_cell_labels])
NK_cell_labels_num = sum(cell_labels_num[NK_cell_labels])
Myeloid_labels_num = sum(cell_labels_num[Myeloid_labels])
Rare_cell_labels_num = sum(cell_labels_num[Rare_cell_labels])
Unclassified_labels_num = sum(cell_labels_num[Unclassified_labels])

cell_num = sum(cell_labels_num)


##### 3 Preparation of Plotting Data for Cell Label Classification (Inner Ring) #####
cell_label_type_data <- data.frame(
  cell_label_type = c("T Lymphocytes", "B Lymphocytes", "NK Lymphocytes", "Myeloid", "Rare", "Unclassified"),
  cell_label_type_num = c(T_cell_labels_num, B_cell_labels_num, NK_cell_labels_num, Myeloid_labels_num, Rare_cell_labels_num, Unclassified_labels_num),
  share = c(T_cell_labels_num, B_cell_labels_num, NK_cell_labels_num, Myeloid_labels_num, Rare_cell_labels_num, Unclassified_labels_num) / cell_num
)
cell_label_type_data <- cell_label_type_data %>%
  mutate(cell_label_type = factor(cell_label_type, levels = c(
    "B Lymphocytes", "T Lymphocytes", "NK Lymphocytes", "Myeloid", "Rare", "Unclassified")))

# Calculating Percentages and Label Positions
cell_label_type_data <- cell_label_type_data %>%
  mutate(
    percentage = share / sum(share),
    label_pos = (cumsum(share) - share / 2) * 100
  ) %>%
  arrange(desc(cell_label_type)) %>%
  mutate(label = paste0(cell_label_type, "\n", round(percentage * 100, 1), "%\n", cell_label_type_num))
cell_label_type_data$label_pos = 100 - cell_label_type_data$label_pos


##### 4 Preparation of Plotting Data for Cell Label Classification (Outer Ring) #####
cell_label_data <- data.frame(
  cell_label = cell_labels,
  cell_label_num = as.numeric(cell_labels_num),
  share = as.numeric(cell_labels_num) / cell_num
)
cell_label_data <- cell_label_data %>%
  mutate(cell_label = factor(cell_label, levels = c(
    B_cell_labels, T_cell_labels, NK_cell_labels, Myeloid_labels, Rare_cell_labels, Unclassified_labels)))

# Calculating Percentages and Label Positions
cell_label_data <- cell_label_data %>%
  mutate(
    percentage = share / sum(share),
    label_pos = (cumsum(share) - share / 2) * 100
  ) %>%
  arrange(desc(cell_label)) %>%
  mutate(label = paste0(cell_label, "\n", round(percentage * 100, 1), "%\n", cell_label_num))

cell_label_data$label_pos = 100 - cell_label_data$label_pos

for (i in 1:nrow(cell_label_data)) {
  if (cell_label_data$percentage[i] < 0.04) {
    parts <- strsplit(cell_label_data$label[i], "\n")[[1]]
    cell_label_data$label[i] <- parts[1]
  }
}; rm(parts, i)


cell_label_data[20, "label"] = "Naive B\n"
cell_label_data[2, "label"] = "pDC\n"
cell_label_data[12, "label"] = "CD8 TEM_1\n"
cell_label_data[10, "label"] = "Treg\n\n"
cell_label_data[8, "label"] = "MAIT\n"


##### 5 Setting Ring Size #####
# Setting the Reference X-value for Inner and Outer Rings
inner_x_value <- 1
outer_x_value <- 2

# Calculate and set the x-axis range. The range should include the x-values of both inner and outer rings and their bar widths.
# Assuming a bar width of 1, the x-axis lower limit should be < (inner_x_value - width/2)
# and the x-axis upper limit should be > (outer_x_value + width/2)
x_lower_limit <- inner_x_value - 1.5
x_upper_limit <- outer_x_value + 1.5


##### 6 Set Color #####
### Define the base colors for the 6 categories in the inner ring
inner_base_colors <- c(
  "B Lymphocytes" = "pink", 
  "T Lymphocytes" = "lightgreen",
  "NK Lymphocytes" = "lightblue", 
  "Myeloid" = "orange",
  "Rare" = "#00E5FF", 
  "Unclassified" = "lightgrey"
)

### Add parent group (inner ring category) information for outer ring data
# Map each detailed cell_label to its corresponding cell_label_type
cell_label_data <- cell_label_data %>%
  mutate(parent_group = case_when(
    cell_label %in% c("Naive B", "Intermediate B", "Memory B", "Plasma") ~ "B Lymphocytes",
    cell_label %in% c("CD4 Naive", "CD4 TCM", "CD4 TEM", "CD8 Naive", "CD8 TEM_1", "CD8 TEM_2", "Treg", "gdT", "MAIT") ~ "T Lymphocytes",
    cell_label == "NK" ~ "NK Lymphocytes",
    cell_label %in% c("CD14 Mono", "CD16 Mono", "cDC") ~ "Myeloid",
    cell_label %in% c("HSPC", "pDC") ~ "Rare",
    cell_label == "filtered" ~ "Unclassified",
    TRUE ~ NA_character_ 
  ))

### Generate outer ring colors: Apply lightening or darkening based on the base color of the parent group
# Generate a color for each outer ring category: slightly darken the base color of its parent group
set.seed(123) 
outer_colors <- character(nrow(cell_label_data))

for (i in 1:nrow(cell_label_data)) {
  base_color <- inner_base_colors[cell_label_data$parent_group[i]]
  darkness_factor <- runif(1, min = 0.15, max = 0.35)
  outer_colors[i] <- darken(base_color, amount = 0.03 + (i + 1) %% 9 * 0.03)
}

# Name the generated color vector for use in scale_fill_manual
names(outer_colors) <- cell_label_data$cell_label


##### 7 Plotting #####
combined_doughnut <- ggplot() +
  # First add outer ring layer
  geom_bar(
    data = cell_label_data,
    aes(x = outer_x_value, y = share, fill = cell_label), 
    stat = "identity",
    width = 1, 
    color = "white"
  ) +
  scale_fill_manual(values = outer_colors) +
  new_scale_fill() + 
  
  # Then add inner ring layer (later layers appear on top of previous ones)
  geom_bar(
    data = cell_label_type_data,
    aes(x = inner_x_value, y = share, fill = cell_label_type), # x映射为较小的值
    stat = "identity",
    width = 1,
    color = "white"
  ) +
  scale_fill_manual(values = inner_base_colors) +
  
  # Add labels for outer ring
  geom_text(
    data = cell_label_data,
    aes(x = outer_x_value, y = share, label = label),
    color = "black",
    size = 4, 
    position = position_stack(vjust = 0.5)
  ) +
  scale_size_continuous(range = c(2, 4), guide = "none") + 
  
  # Add labels for inner ring
  geom_text(
    data = cell_label_type_data,
    aes(x = inner_x_value, y = share, label = label),
    color = "black",
    size = 4, # 设置内环标签字号
    position = position_stack(vjust = 0.5)
  ) +
  
  # Coordinate transformation: convert all bars to polar coordinates to form doughnut chart
  coord_polar(theta = "y", start = 0) +
  # Set x-axis range to control ring radius and visibility
  xlim(x_lower_limit, x_upper_limit) +
  theme_void() +
  theme(
    legend.position = "none"
  )

print(combined_doughnut)

ggsave(filename = "./Results/1 dataset/DoughnutChart.png", plot = combined_doughnut,
       width = 10, height = 10)
